<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeamSpeed Network Migration Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* Login */
        .login-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 400px; text-align: center; }
        .login-logo { font-size: 3em; font-weight: bold; color: #4285f4; opacity: 0.2; margin-bottom: 20px; }
        .login-title { font-size: 1.8em; color: #4285f4; margin-bottom: 10px; }
        .login-subtitle { color: #6b7280; margin-bottom: 30px; }
        .login-input { width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px; transition: all 0.3s ease; }
        .login-input:focus { outline: none; border-color: #4285f4; box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
        .login-button { width: 100%; padding: 12px 20px; background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .login-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4); }
        .login-error { color: #ef4444; margin-top: 15px; font-size: 14px; }
        
        /* Dashboard */
        .dashboard-view { background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%); min-height: 100vh; margin: -20px; padding: 0; color: #e0e0e0; }
        .dashboard-header { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 25px 40px; display: flex; justify-content: space-between; align-items: center; }
        .dash-logo-section { display: flex; align-items: center; gap: 20px; }
        .dash-logo { font-size: 2em; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .dash-title { color: #fff; font-size: 1.5em; font-weight: 300; }
        .dash-header-actions { display: flex; gap: 15px; align-items: center; }
        .sync-indicator { display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 20px; color: #10b981; font-size: 0.9em; }
        .sync-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .view-toggle { display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 4px; }
        .view-btn { padding: 8px 16px; background: transparent; border: none; color: #9ca3af; cursor: pointer; border-radius: 6px; transition: all 0.3s ease; }
        .view-btn.active { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .dashboard-content { padding: 30px 40px; max-width: 1600px; margin: 0 auto; }
        .kpi-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .kpi-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 25px; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.05); border-color: rgba(99, 102, 241, 0.3); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2); }
        .kpi-label { color: #9ca3af; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .kpi-value { font-size: 2.5em; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .kpi-change { display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; background: rgba(16, 185, 129, 0.1); color: #10b981; border-radius: 6px; font-size: 0.85em; }
        .progress-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 40px; }
        .migration-timeline { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 25px; }
        .section-title { color: #fff; font-size: 1.2em; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        .phase-container { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .phase-container::before { content: ''; position: absolute; top: 20px; left: 10%; right: 10%; height: 2px; background: rgba(255, 255, 255, 0.1); z-index: 0; }
        .phase { text-align: center; position: relative; z-index: 1; }
        .phase-dot { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.3s ease; }
        .phase.active .phase-dot { background: linear-gradient(135deg, #667eea, #764ba2); border-color: #667eea; box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
        .phase.completed .phase-dot { background: #10b981; border-color: #10b981; }
        .phase-label { color: #9ca3af; font-size: 0.9em; }
        .phase-count { color: #fff; font-weight: bold; margin-top: 5px; }
        .priority-chart { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 25px; }
        .priority-bars { display: flex; flex-direction: column; gap: 15px; }
        .priority-item { display: flex; align-items: center; gap: 15px; }
        .priority-label { width: 60px; color: #9ca3af; font-size: 0.9em; }
        .priority-bar-container { flex: 1; height: 30px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; overflow: hidden; position: relative; }
        .priority-bar { height: 100%; display: flex; align-items: center; padding: 0 10px; color: #fff; font-weight: bold; font-size: 0.9em; transition: width 1s ease; }
        .priority-high-bar { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .priority-medium-bar { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .priority-low-bar { background: linear-gradient(90deg, #4285f4, #3367d6); }
        .sites-section { margin-bottom: 40px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filter-tabs { display: flex; gap: 10px; }
        .filter-tab { padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #9ca3af; cursor: pointer; transition: all 0.3s ease; }
        .filter-tab.active { background: rgba(99, 102, 241, 0.2); border-color: rgba(99, 102, 241, 0.5); color: #818cf8; }
        .sites-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .site-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer; }
        .site-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.05); border-color: rgba(99, 102, 241, 0.3); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .site-header-card { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .site-name { color: #fff; font-weight: bold; font-size: 1.1em; }
        .site-id { color: #6b7280; font-size: 0.85em; margin-top: 2px; }
        .site-status { padding: 4px 8px; border-radius: 6px; font-size: 0.75em; font-weight: bold; }
        .status-active-card { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-inactive-card { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .site-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .site-metric { display: flex; flex-direction: column; }
        .metric-label { color: #6b7280; font-size: 0.75em; text-transform: uppercase; margin-bottom: 3px; }
        .metric-value { color: #fff; font-weight: bold; }
        
        /* Table */
        .container { background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; max-width: 100%; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%); color: white; padding: 30px; text-align: center; position: relative; overflow: hidden; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; position: relative; z-index: 1; }
        .header .subtitle { font-size: 1.2em; opacity: 0.9; position: relative; z-index: 1; }
        .header .date { margin-top: 15px; font-size: 1em; opacity: 0.8; position: relative; z-index: 1; }
        .logo { position: absolute; top: 20px; right: 30px; font-size: 3em; font-weight: bold; opacity: 0.2; transform: rotate(-10deg); }
        .sync-status { position: absolute; top: 20px; left: 30px; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9em; }
        .controls { background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: #4285f4; color: white; }
        .btn-export { background: #2563eb; color: white; position: relative; }
        .btn-export:hover { background: #1e40af; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4); }
        .export-dropdown { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: none; z-index: 100; margin-top: 5px; min-width: 150px; }
        .export-dropdown.show { display: block; }
        .export-option { padding: 10px 15px; cursor: pointer; transition: background 0.2s ease; display: flex; align-items: center; gap: 10px; color: #333; }
        .export-option:hover { background: #f3f4f6; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4); }
        .btn-secondary { background: #8b5cf6; color: white; }
        .btn-secondary:hover { background: #7c3aed; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4); }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); }
        .btn-danger { background: #ef4444; color: white; padding: 6px 12px; font-size: 12px; }
        .btn-danger:hover { background: #dc2626; transform: scale(1.05); }
        .btn-dashboard { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .search-box { flex: 1; min-width: 200px; padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; transition: all 0.3s ease; }
        .search-box:focus { outline: none; border-color: #4285f4; box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
        .table-container { overflow-x: auto; max-height: 600px; position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
        thead { background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%); position: sticky; top: 0; z-index: 10; }
        th { padding: 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; white-space: nowrap; cursor: pointer; user-select: none; transition: background 0.3s ease; }
        .category-header { background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); color: white; text-align: center; font-weight: bold; letter-spacing: 1px; }
        td { padding: 10px 12px; border-bottom: 1px solid #e9ecef; white-space: nowrap; position: relative; }
        tr:hover { background: #f0f4ff; transition: background 0.2s ease; }
        .city-row { background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); color: white; font-weight: bold; cursor: pointer; user-select: none; }
        .city-row:hover { background: linear-gradient(90deg, #7c7ff3 0%, #9d70f8 100%); }
        .city-row td { padding: 15px 12px; border-bottom: 2px solid #dee2e6; }
        .location-row { background: #e0e7ff; color: #4338ca; font-weight: 600; cursor: pointer; user-select: none; }
        .location-row:hover { background: #c7d2fe; }
        .location-row td { padding: 12px; border-bottom: 1px solid #cbd5e1; }
        .expand-icon { display: inline-block; width: 20px; transition: transform 0.3s ease; }
        .expand-icon.collapsed { transform: rotate(-90deg); }
        .device-row { background: white; border-left: 4px solid transparent; transition: all 0.2s ease; }
        .device-row.hidden, .location-row.hidden { display: none; }
        .device-row:hover { background: #e0e7ff !important; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .editable { background: transparent; border: 1px solid transparent; padding: 5px 8px; width: 100%; min-width: 100px; transition: all 0.3s ease; }
        .editable:hover { background: white; border-color: #e5e7eb; }
        .editable:focus { outline: none; background: white; border-color: #4285f4; box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); }
        .footer { background: #f8f9fa; padding: 20px; text-align: center; border-top: 1px solid #e9ecef; }
        .stats { display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: wrap; gap: 20px; }
        .stat-card { background: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .stat-value { font-size: 2em; font-weight: bold; color: #4285f4; }
        .stat-label { color: #6b7280; font-size: 0.9em; margin-top: 5px; }
        .loading { text-align: center; padding: 50px; color: #6b7280; font-size: 1.1em; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal h3 { color: #4285f4; margin-bottom: 20px; }
        .modal label { display: block; margin-bottom: 8px; color: #495057; font-weight: 500; margin-top: 15px; }
        .modal select, .modal input[type="text"], .modal input[type="date"] { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
        .modal input:disabled { background: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .modal-actions { display: flex; gap: 10px; margin-top: 25px; justify-content: flex-end; }
        .info-box { margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; font-size: 13px; color: #1e40af; border: 1px solid #bfdbfe; }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">resound</div>
            <h2 class="login-title">BeamSpeed Migration Tracker</h2>
            <p class="login-subtitle">Please enter your credentials to access the tracker</p>
            <input type="text" id="loginUsername" class="login-input" placeholder="Username" autofocus>
            <input type="password" id="loginPassword" class="login-input" placeholder="Password" onkeypress="if(event.key==='Enter') attemptLogin()">
            <button class="login-button" onclick="attemptLogin()">Login</button>
            <div id="loginError" class="login-error hidden"></div>
        </div>
    </div>
    
    <div class="dashboard-view hidden" id="dashboardView">
        <div class="dashboard-header">
            <div class="dash-logo-section">
                <div class="dash-logo">resound</div>
                <div class="dash-title">BeamSpeed Network Migration</div>
            </div>
            <div class="dash-header-actions">
                <div class="sync-indicator">
                    <div class="sync-dot"></div>
                    <span>Live Sync Active</span>
                </div>
                <div class="view-toggle">
                    <button class="view-btn" id="tableViewBtn" onclick="toggleView()">Table View</button>
                    <button class="view-btn active" id="dashboardViewBtn">Dashboard</button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="kpi-section">
                <div class="kpi-card">
                    <div class="kpi-label">Total Cities</div>
                    <div class="kpi-value" id="dashTotalCities">0</div>
                    <span class="kpi-change">Live Data</span>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Locations</div>
                    <div class="kpi-value" id="dashTotalLocations">0</div>
                    <span class="kpi-change">Live Data</span>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Devices</div>
                    <div class="kpi-value" id="dashTotalDevices">0</div>
                    <span class="kpi-change">Live Data</span>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Active Devices</div>
                    <div class="kpi-value" id="dashActiveDevices">0</div>
                    <span class="kpi-change">Live Data</span>
                </div>
            </div>
            
            <div class="progress-section">
                <div class="migration-timeline">
                    <div class="section-title">
                        Migration Timeline
                        <span style="color: #6b7280; font-size: 0.9em;">Q4 2025 - Q1 2026</span>
                    </div>
                    <div class="phase-container">
                        <div class="phase" id="phase1">
                            <div class="phase-dot">1</div>
                            <div class="phase-label">Phase 1</div>
                            <div class="phase-count" id="phase1Count">0 devices</div>
                        </div>
                        <div class="phase" id="phase2">
                            <div class="phase-dot">2</div>
                            <div class="phase-label">Phase 2</div>
                            <div class="phase-count" id="phase2Count">0 devices</div>
                        </div>
                        <div class="phase" id="phase3">
                            <div class="phase-dot">3</div>
                            <div class="phase-label">Phase 3</div>
                            <div class="phase-count" id="phase3Count">0 devices</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #9ca3af;">Overall Progress</span>
                            <span style="color: #fff; font-weight: bold;" id="overallProgressText">0%</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div id="overallProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 1s ease;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="priority-chart">
                    <div class="section-title">Priority Distribution</div>
                    <div class="priority-bars">
                        <div class="priority-item">
                            <span class="priority-label">High</span>
                            <div class="priority-bar-container">
                                <div class="priority-bar priority-high-bar" id="highPriorityBar" style="width: 0%;">0 devices</div>
                            </div>
                        </div>
                        <div class="priority-item">
                            <span class="priority-label">Medium</span>
                            <div class="priority-bar-container">
                                <div class="priority-bar priority-medium-bar" id="mediumPriorityBar" style="width: 0%;">0 devices</div>
                            </div>
                        </div>
                        <div class="priority-item">
                            <span class="priority-label">Low</span>
                            <div class="priority-bar-container">
                                <div class="priority-bar priority-low-bar" id="lowPriorityBar" style="width: 0%;">0 devices</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sites-section">
                <div class="section-header">
                    <div class="section-title">Site Overview</div>
                    <div class="filter-tabs">
                        <div class="filter-tab active" onclick="filterSites('all',event)">All Sites</div>
                        <div class="filter-tab" onclick="filterSites('active',event)">Active</div>
                        <div class="filter-tab" onclick="filterSites('pending',event)">Pending</div>
                        <div class="filter-tab" onclick="filterSites('completed',event)">Completed</div>
                    </div>
                </div>
                <div class="sites-grid" id="sitesGrid"></div>
            </div>
        </div>
    </div>
    
    <div class="container hidden" id="mainContainer">
        <div class="header">
            <div class="sync-status" id="syncStatus">✅ Connected to Supabase</div>
            <div class="logo">resound</div>
            <h1>BeamSpeed Network Migration Tracker</h1>
            <div class="subtitle">Real-Time Multi-User Dashboard</div>
            <div class="date">Project Timeline: Q4 2025 - Q1 2026</div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="loadData()">🔄 Refresh</button>
            <button class="btn btn-success" onclick="addRow()">🏢 Add Site</button>
            <button class="btn btn-secondary" onclick="addDevice()">📡 Add Device</button>
            <button class="btn btn-warning" onclick="undoLastChange()">↩️ Undo</button>
            <div style="position: relative; display: inline-block;">
                <button class="btn btn-export" onclick="toggleExportDropdown(event)">📊 Export ▼</button>
                <div class="export-dropdown" id="exportDropdown">
                    <div class="export-option" onclick="exportToExcel()">📗 Export to Excel</div>
                    <div class="export-option" onclick="exportToPDF()">📕 Export to PDF</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="sortTable('siteid')">🏢 Sort by Site</button>
            <button class="btn btn-primary" onclick="sortTable('sitetype')">📍 Sort by Site Type</button>
            <button class="btn btn-dashboard" onclick="toggleView()">📈 Dashboard</button>
            <button class="btn btn-danger" onclick="logout()" style="margin-left: auto;">🔒 Logout</button>
            <input type="text" class="search-box" placeholder="🔍 Search sites, devices, or IPs..." onkeyup="filterTable(this.value)">
        </div>
        
        <div class="footer">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCities">0</div>
                    <div class="stat-label">Total Cities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalLocations">0</div>
                    <div class="stat-label">Total Locations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDevices">0</div>
                    <div class="stat-label">Total Devices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeDevices">0</div>
                    <div class="stat-label">Active Devices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <div class="loading" id="loadingMessage">Loading data from Supabase...</div>
            <table id="migrationTable" style="display: none;">
                <thead>
                    <tr>
                        <th colspan="4" class="category-header">SITE INFORMATION</th>
                        <th colspan="5" class="category-header">NETWORK DETAILS</th>
                        <th colspan="4" class="category-header">CONNECTIVITY</th>
                        <th colspan="5" class="category-header">MIGRATION</th>
                        <th colspan="1" class="category-header">ACTIONS</th>
                    </tr>
                    <tr>
                        <th>City/State</th>
                        <th>Location Name</th>
                        <th>Physical Address</th>
                        <th>Site Type</th>
                        <th>Device Name</th>
                        <th>Device Type</th>
                        <th>Management IP</th>
                        <th>Username</th>
                        <th>Password</th>
                        <th>Status</th>
                        <th>Circuit ID</th>
                        <th>ISP/Provider</th>
                        <th>Bandwidth</th>
                        <th>Customer Count</th>
                        <th>Migration Phase</th>
                        <th>Migration Date</th>
                        <th>Priority</th>
                        <th>Notes</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal for Site Type Selection -->
    <div class="modal-overlay" id="siteTypeSelector">
        <div class="modal">
            <h3>What would you like to add?</h3>
            <p style="margin-bottom: 25px; color: #6b7280;">Choose whether to add a new city or a site location within an existing city.</p>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div onclick="selectSiteType('city')" style="flex: 1; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-size: 2em; margin-bottom: 10px;">🏙️</div>
                    <div style="color: white; font-weight: bold; font-size: 1.1em;">Add New City</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 5px;">Create a new city/state</div>
                </div>
                
                <div onclick="selectSiteType('location')" style="flex: 1; padding: 25px; background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-size: 2em; margin-bottom: 10px;">📍</div>
                    <div style="color: white; font-weight: bold; font-size: 1.1em;">Add Site Location</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 5px;">Add location to existing city</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" style="background: #e5e7eb;" onclick="closeSiteTypeSelector()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Add City -->
    <div class="modal-overlay" id="cityModal">
        <div class="modal">
            <h3>Create New City</h3>
            <p style="margin-bottom: 20px; color: #6b7280;">Enter the city information:</p>
            
            <label>City:</label>
            <input type="text" id="newCity" placeholder="e.g., DALLAS, PHOENIX, YUMA" style="text-transform: uppercase;">
            
            <label>State (2-letter code):</label>
            <input type="text" id="newState" placeholder="e.g., TX, AZ, CA" maxlength="2" style="text-transform: uppercase;">
            
            <div class="info-box">
                💡 This will create city: <strong id="cityPreview">CITY, ST</strong>
            </div>
            
            <div class="modal-actions">
                <button class="btn" style="background: #e5e7eb;" onclick="closeCityModal()">Cancel</button>
                <button class="btn btn-success" onclick="createNewCity()">Create City</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Add Location -->
    <div class="modal-overlay" id="locationModal">
        <div class="modal">
            <h3>Add Site Location</h3>
            <p style="margin-bottom: 20px; color: #6b7280;">Add a new site location to an existing city:</p>
            
            <label>Select City:</label>
            <select id="cityDropdownForLocation" onchange="updateLocationCity()">
                <option value="">Choose a city...</option>
            </select>
            
            <label>Location Name:</label>
            <input type="text" id="locationName" placeholder="e.g., HQ DataCenter, Tower Site #5">
            
            <label>Physical Address:</label>
            <input type="text" id="locationAddress" placeholder="e.g., 123 Main St, Suite 100">
            
            <label>Site Type:</label>
            <select id="newLocationType">
                <option value="Data Center">Data Center</option>
                <option value="Tower Site">Tower Site</option>
                <option value="Cabinet">Cabinet</option>
                <option value="Office">Office</option>
                <option value="Colocation">Colocation</option>
                <option value="POP">POP</option>
            </select>
            
            <div class="info-box">
                💡 This location will be added under the selected city
            </div>
            
            <div class="modal-actions">
                <button class="btn" style="background: #e5e7eb;" onclick="closeLocationModal()">Cancel</button>
                <button class="btn btn-success" onclick="createNewLocation()">Add Location</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Add Device -->
    <div class="modal-overlay" id="deviceModal">
        <div class="modal">
            <h3>Add Device to Existing Location</h3>
            <p style="margin-bottom: 20px; color: #6b7280;">Select the city and location for this device:</p>
            
            <label>Select City:</label>
            <select id="deviceCity" onchange="updateLocationDropdown()">
                <option value="">Choose a city...</option>
            </select>
            
            <label>Select Location:</label>
            <select id="deviceLocation" onchange="updateDeviceFields()">
                <option value="">Choose a location...</option>
            </select>
            
            <label>Site Name (Auto-populated):</label>
            <input type="text" id="deviceSiteName" disabled>
            
            <label>Physical Address (Auto-populated):</label>
            <input type="text" id="deviceAddress" disabled>
            
            <label>Site Type (Auto-populated):</label>
            <input type="text" id="deviceSiteType" disabled>
            
            <label>Device Name:</label>
            <input type="text" id="deviceName" placeholder="e.g., Core Router 1" value="New Device">
            
            <label>Device Type:</label>
            <select id="deviceType">
                <option value="Router">Router</option>
                <option value="Switch">Switch</option>
                <option value="Firewall">Firewall</option>
                <option value="Server">Server</option>
                <option value="AP">Access Point</option>
                <option value="Other">Other</option>
            </select>
            
            <div class="info-box">
                💡 The device will inherit all site information from the selected location
            </div>
            
            <div class="modal-actions">
                <button class="btn" style="background: #e5e7eb;" onclick="closeDeviceModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="createNewDevice()">Add Device</button>
            </div>
        </div>
    </div>

    <script>
        const AUTH_CONFIG = { username: 'beamspeed', password: 'Resound2026' };
        const supabaseUrl = 'https://lutaijsslnpgvnbwbatt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dGFpanNzbG5wZ3ZuYndiYXR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTY0MzksImV4cCI6MjA3NDQzMjQzOX0.L1CtWNA1XTsIHETX4ITft9UusGmPZ2BQwPUSoHYZgqc';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        
        let allData = [];
        let undoHistory = [];
        const MAX_UNDO_HISTORY = 10;
        let sortDirection = 'asc';
        let currentView = 'table';
        let currentFilter = 'all';
        
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('authenticated') === 'true';
            if (isAuthenticated) {
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                loadData();
            }
        }
        
        function attemptLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (username === AUTH_CONFIG.username && password === AUTH_CONFIG.password) {
                sessionStorage.setItem('authenticated', 'true');
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                loadData();
            } else {
                errorDiv.textContent = 'Invalid username or password';
                errorDiv.classList.remove('hidden');
                setTimeout(() => errorDiv.classList.add('hidden'), 3000);
            }
        }
        
        function logout() {
            sessionStorage.removeItem('authenticated');
            location.reload();
        }
        
        function toggleView() {
            if (currentView === 'table') {
                currentView = 'dashboard';
                document.getElementById('mainContainer').classList.add('hidden');
                document.getElementById('dashboardView').classList.remove('hidden');
                document.getElementById('dashboardViewBtn').classList.add('active');
                document.getElementById('tableViewBtn').classList.remove('active');
                updateDashboard();
            } else {
                currentView = 'table';
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
            }
        }
        
        async function loadData() {
            document.getElementById('syncStatus').textContent = '🔄 Loading...';
            
            try {
                const { data, error } = await supabaseClient
                    .from('migration_tracker')
                    .select('*')
                    .order('siteid', { ascending: true });
                
                if (error) throw error;
                
                allData = data || [];
                renderTable();
                updateStats();
                updateDashboard();
                
                document.getElementById('syncStatus').textContent = '✅ Connected to Supabase';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('syncStatus').textContent = '❌ Connection Failed';
            }
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('migrationTable').style.display = 'table';
            
            const grouped = {};
            
            allData.forEach(item => {
                const cityKey = item.siteid || 'UNASSIGNED';
                if (!grouped[cityKey]) {
                    grouped[cityKey] = { locations: {} };
                }
                
                if (item.sitename) {
                    const locationKey = item.sitename;
                    if (!grouped[cityKey].locations[locationKey]) {
                        grouped[cityKey].locations[locationKey] = [];
                    }
                    if (item.devicename) {
                        grouped[cityKey].locations[locationKey].push(item);
                    }
                }
            });
            
            Object.entries(grouped).forEach(([city, cityData]) => {
                const cityRow = document.createElement('tr');
                cityRow.className = 'city-row';
                cityRow.innerHTML = `
                    <td colspan="19">
                        <span class="expand-icon">▼</span> ${city}
                    </td>
                `;
                cityRow.onclick = () => toggleCityCollapse(city);
                tbody.appendChild(cityRow);
                
                Object.entries(cityData.locations).forEach(([location, devices]) => {
                    const locationRow = document.createElement('tr');
                    locationRow.className = 'location-row';
                    locationRow.dataset.city = city;
                    
                    const firstDevice = devices[0] || {};
                    locationRow.innerHTML = `
                        <td></td>
                        <td>
                            <span class="expand-icon">▼</span> ${location}
                        </td>
                        <td>${firstDevice.address || ''}</td>
                        <td>${firstDevice.sitetype || ''}</td>
                        <td colspan="15"></td>
                    `;
                    locationRow.onclick = () => toggleLocationCollapse(city, location);
                    tbody.appendChild(locationRow);
                    
                    devices.forEach(device => {
                        const deviceRow = document.createElement('tr');
                        deviceRow.className = 'device-row';
                        deviceRow.dataset.city = city;
                        deviceRow.dataset.location = location;
                        deviceRow.innerHTML = createDeviceRowHTML(device);
                        tbody.appendChild(deviceRow);
                    });
                });
            });
        }
        
        function createDeviceRowHTML(device) {
            return `
                <td></td><td></td><td></td><td></td>
                <td><input class="editable" value="${device.devicename || ''}" onchange="updateCell(${device.id}, 'devicename', this.value)"></td>
                <td><input class="editable" value="${device.devicetype || ''}" onchange="updateCell(${device.id}, 'devicetype', this.value)"></td>
                <td><input class="editable" value="${device.managementip || ''}" onchange="updateCell(${device.id}, 'managementip', this.value)"></td>
                <td><input class="editable" value="${device.username || ''}" onchange="updateCell(${device.id}, 'username', this.value)"></td>
                <td><input class="editable" type="password" value="${device.password || ''}" onchange="updateCell(${device.id}, 'password', this.value)"></td>
                <td>
                    <select class="editable" onchange="updateCell(${device.id}, 'status', this.value)">
                        <option value="Active" ${device.status === 'Active' ? 'selected' : ''}>Active</option>
                        <option value="Shutdown" ${device.status === 'Shutdown' ? 'selected' : ''}>Shutdown</option>
                        <option value="Inactive" ${device.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                    </select>
                </td>
                <td><input class="editable" value="${device.circuitid || ''}" onchange="updateCell(${device.id}, 'circuitid', this.value)"></td>
                <td><input class="editable" value="${device.ispprovider || ''}" onchange="updateCell(${device.id}, 'ispprovider', this.value)"></td>
                <td><input class="editable" value="${device.bandwidth || ''}" onchange="updateCell(${device.id}, 'bandwidth', this.value)"></td>
                <td><input class="editable" value="${device.customercount || ''}" onchange="updateCell(${device.id}, 'customercount', this.value)"></td>
                <td>
                    <select class="editable" onchange="updateCell(${device.id}, 'migrationphase', this.value)">
                        <option value="Phase 1" ${device.migrationphase === 'Phase 1' ? 'selected' : ''}>Phase 1</option>
                        <option value="Phase 2" ${device.migrationphase === 'Phase 2' ? 'selected' : ''}>Phase 2</option>
                        <option value="Phase 3" ${device.migrationphase === 'Phase 3' ? 'selected' : ''}>Phase 3</option>
                        <option value="Complete" ${device.migrationphase === 'Complete' ? 'selected' : ''}>Complete</option>
                    </select>
                </td>
                <td><input class="editable" type="date" value="${device.migrationdate || ''}" onchange="updateCell(${device.id}, 'migrationdate', this.value)"></td>
                <td>
                    <select class="editable" onchange="updateCell(${device.id}, 'priority', this.value)">
                        <option value="High" ${device.priority === 'High' ? 'selected' : ''}>High</option>
                        <option value="Medium" ${device.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="Low" ${device.priority === 'Low' ? 'selected' : ''}>Low</option>
                    </select>
                </td>
                <td><input class="editable" value="${device.notes || ''}" onchange="updateCell(${device.id}, 'notes', this.value)"></td>
                <td><button class="btn btn-danger" onclick="deleteRow(${device.id})">Delete</button></td>
            `;
        }
        
        function toggleCityCollapse(city) {
            const locationRows = document.querySelectorAll(`.location-row[data-city="${city}"]`);
            const deviceRows = document.querySelectorAll(`.device-row[data-city="${city}"]`);
            
            locationRows.forEach(row => row.classList.toggle('hidden'));
            deviceRows.forEach(row => row.classList.toggle('hidden'));
            
            const cityRow = event.currentTarget;
            const icon = cityRow.querySelector('.expand-icon');
            if (icon) {
                icon.classList.toggle('collapsed');
            }
        }
        
        function toggleLocationCollapse(city, location) {
            const deviceRows = document.querySelectorAll(`.device-row[data-city="${city}"][data-location="${location}"]`);
            deviceRows.forEach(row => row.classList.toggle('hidden'));
            
            const locationRow = event.currentTarget;
            const icon = locationRow.querySelector('.expand-icon');
            if (icon) {
                icon.classList.toggle('collapsed');
            }
        }
        
        async function updateCell(id, field, value) {
            try {
                const { error } = await supabaseClient
                    .from('migration_tracker')
                    .update({ [field]: value })
                    .eq('id', id);
                
                if (error) throw error;
                
                const item = allData.find(d => d.id === id);
                if (item) {
                    undoHistory.push({ id, field, oldValue: item[field], newValue: value });
                    if (undoHistory.length > MAX_UNDO_HISTORY) undoHistory.shift();
                    item[field] = value;
                }
                
                updateStats();
                if (currentView === 'dashboard') updateDashboard();
                
            } catch (error) {
                console.error('Error updating:', error);
                alert('Failed to update. Please try again.');
            }
        }
        
        async function deleteRow(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('migration_tracker')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadData();
                
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete. Please try again.');
            }
        }
        
        async function undoLastChange() {
            if (undoHistory.length === 0) {
                alert('No changes to undo');
                return;
            }
            
            const lastChange = undoHistory.pop();
            
            try {
                const { error } = await supabaseClient
                    .from('migration_tracker')
                    .update({ [lastChange.field]: lastChange.oldValue })
                    .eq('id', lastChange.id);
                
                if (error) throw error;
                
                loadData();
                
            } catch (error) {
                console.error('Error undoing:', error);
                alert('Failed to undo. Please try again.');
            }
        }
        
        function updateStats() {
            const cities = new Set();
            const locations = new Set();
            let deviceCount = 0;
            let activeCount = 0;
            let completedCount = 0;
            
            allData.forEach(item => {
                if (!item.sitename && !item.devicename) {
                    cities.add(item.siteid);
                } else if (item.sitename && !item.devicename) {
                    locations.add(`${item.siteid}|${item.sitename}`);
                } else if (item.devicename) {
                    deviceCount++;
                    if (item.status === 'Active') activeCount++;
                    if (item.migrationphase === 'Complete') completedCount++;
                }
            });
            
            document.getElementById('totalCities').textContent = cities.size;
            document.getElementById('totalLocations').textContent = locations.size;
            document.getElementById('totalDevices').textContent = deviceCount;
            document.getElementById('activeDevices').textContent = activeCount;
            document.getElementById('completed').textContent = completedCount;
        }
        
        function updateDashboard() {
            if (!allData || allData.length === 0) return;
            
            const cities = new Set();
            const locations = new Set();
            let deviceCount = 0;
            let activeDevices = 0;
            
            allData.forEach(item => {
                if (!item.sitename && !item.devicename) {
                    cities.add(item.siteid);
                } else if (item.sitename && !item.devicename) {
                    locations.add(`${item.siteid}|${item.sitename}`);
                } else if (item.devicename) {
                    deviceCount++;
                    if (item.status === 'Active') activeDevices++;
                }
            });
            
            const completedDevices = allData.filter(item => item.migrationphase === 'Complete' && item.devicename).length;
            const migrationProgress = deviceCount > 0 ? Math.round((completedDevices / deviceCount) * 100) : 0;
            
            document.getElementById('dashTotalCities').textContent = cities.size;
            document.getElementById('dashTotalLocations').textContent = locations.size;
            document.getElementById('dashTotalDevices').textContent = deviceCount;
            document.getElementById('dashActiveDevices').textContent = activeDevices;
            
            document.getElementById('overallProgressBar').style.width = migrationProgress + '%';
            document.getElementById('overallProgressText').textContent = migrationProgress + '%';
            
            const phase1Count = allData.filter(item => item.migrationphase === 'Phase 1' && item.devicename).length;
            const phase2Count = allData.filter(item => item.migrationphase === 'Phase 2' && item.devicename).length;
            const phase3Count = allData.filter(item => item.migrationphase === 'Phase 3' && item.devicename).length;
            
            document.getElementById('phase1Count').textContent = phase1Count + ' devices';
            document.getElementById('phase2Count').textContent = phase2Count + ' devices';
            document.getElementById('phase3Count').textContent = phase3Count + ' devices';
            
            document.querySelectorAll('.phase').forEach(p => {
                p.classList.remove('active', 'completed');
            });
            
            if (phase1Count > 0) {
                document.getElementById('phase1').classList.add('active');
            }
            if (phase2Count > 0) {
                document.getElementById('phase1').classList.add('completed');
                document.getElementById('phase2').classList.add('active');
            }
            if (phase3Count > 0) {
                document.getElementById('phase2').classList.add('completed');
                document.getElementById('phase3').classList.add('active');
            }
            if (completedDevices > 0 && completedDevices === deviceCount) {
                document.getElementById('phase3').classList.add('completed');
            }
            
            const highPriority = allData.filter(item => item.priority === 'High' && item.devicename).length;
            const mediumPriority = allData.filter(item => item.priority === 'Medium' && item.devicename).length;
            const lowPriority = allData.filter(item => item.priority === 'Low' && item.devicename).length;
            const maxPriority = Math.max(highPriority, mediumPriority, lowPriority, 1);
            
            const highBar = document.getElementById('highPriorityBar');
            const mediumBar = document.getElementById('mediumPriorityBar');
            const lowBar = document.getElementById('lowPriorityBar');
            
            if (highBar) {
                highBar.style.width = (highPriority / maxPriority * 100) + '%';
                highBar.textContent = highPriority + ' devices';
            }
            if (mediumBar) {
                mediumBar.style.width = (mediumPriority / maxPriority * 100) + '%';
                mediumBar.textContent = mediumPriority + ' devices';
            }
            if (lowBar) {
                lowBar.style.width = (lowPriority / maxPriority * 100) + '%';
                lowBar.textContent = lowPriority + ' devices';
            }
            
            updateSiteCards();
        }
        
        function updateSiteCards() {
            const sitesGrid = document.getElementById('sitesGrid');
            if (!sitesGrid) return;
            
            sitesGrid.innerHTML = '';
            
            const cityGroups = {};
            allData.forEach(item => {
                const cityKey = item.siteid || 'UNASSIGNED';
                
                if (!cityGroups[cityKey]) {
                    cityGroups[cityKey] = {
                        locations: {},
                        totalDevices: 0,
                        totalCustomers: 0,
                        phases: new Set(),
                        statuses: new Set()
                    };
                }
                
                if (item.devicename) {
                    const locationKey = item.sitename || 'UNASSIGNED';
                    if (!cityGroups[cityKey].locations[locationKey]) {
                        cityGroups[cityKey].locations[locationKey] = {
                            devices: [],
                            sitetype: item.sitetype
                        };
                    }
                    cityGroups[cityKey].locations[locationKey].devices.push(item);
                    cityGroups[cityKey].totalDevices++;
                    cityGroups[cityKey].totalCustomers += parseInt(item.customercount) || 0;
                    cityGroups[cityKey].phases.add(item.migrationphase);
                    cityGroups[cityKey].statuses.add(item.status);
                }
            });
            
            Object.entries(cityGroups).forEach(([cityName, cityData]) => {
                if (cityData.totalDevices === 0) return;
                
                let siteStatus = 'INACTIVE';
                let statusClass = 'status-inactive-card';
                if (cityData.statuses.has('Active')) {
                    siteStatus = 'ACTIVE';
                    statusClass = 'status-active-card';
                } else if (cityData.statuses.has('Shutdown')) {
                    siteStatus = 'PENDING';
                    statusClass = 'status-pending';
                }
                
                if (currentFilter !== 'all') {
                    if (currentFilter === 'active' && siteStatus !== 'ACTIVE') return;
                    if (currentFilter === 'pending' && siteStatus !== 'PENDING') return;
                    if (currentFilter === 'completed' && !cityData.phases.has('Complete')) return;
                }
                
                let primaryPhase = 'Phase 1';
                if (cityData.phases.has('Complete')) primaryPhase = 'Complete';
                else if (cityData.phases.has('Phase 3')) primaryPhase = 'Phase 3';
                else if (cityData.phases.has('Phase 2')) primaryPhase = 'Phase 2';
                
                const locationCount = Object.keys(cityData.locations).length;
                
                const card = document.createElement('div');
                card.className = 'site-card';
                card.onclick = () => toggleView();
                
                card.innerHTML = `
                    <div class="site-header-card">
                        <div>
                            <div class="site-name">${cityName || 'Unnamed City'}</div>
                            <div class="site-id">${locationCount} locations, ${cityData.totalDevices} devices</div>
                        </div>
                        <div class="site-status ${statusClass}">${siteStatus}</div>
                    </div>
                    <div class="site-metrics">
                        <div class="site-metric">
                            <span class="metric-label">Locations</span>
                            <span class="metric-value">${locationCount}</span>
                        </div>
                        <div class="site-metric">
                            <span class="metric-label">Devices</span>
                            <span class="metric-value">${cityData.totalDevices}</span>
                        </div>
                        <div class="site-metric">
                            <span class="metric-label">Customers</span>
                            <span class="metric-value">${cityData.totalCustomers}</span>
                        </div>
                        <div class="site-metric">
                            <span class="metric-label">Phase</span>
                            <span class="metric-value">${primaryPhase}</span>
                        </div>
                    </div>
                `;
                
                sitesGrid.appendChild(card);
            });
        }
        
        function filterSites(filter, event) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            updateSiteCards();
        }
        
        function filterTable(searchText) {
            const rows = document.querySelectorAll('#tableBody tr');
            searchText = searchText.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        }
        
        function sortTable(column) {
            allData.sort((a, b) => {
                const aVal = a[column] || '';
                const bVal = b[column] || '';
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            renderTable();
        }
        
        function addRow() {
            document.getElementById('siteTypeSelector').style.display = 'flex';
        }
        
        function closeSiteTypeSelector() {
            document.getElementById('siteTypeSelector').style.display = 'none';
        }
        
        function selectSiteType(type) {
            closeSiteTypeSelector();
            if (type === 'city') {
                document.getElementById('cityModal').style.display = 'flex';
                // Add event listeners for preview
                document.getElementById('newCity').addEventListener('input', updateCityPreview);
                document.getElementById('newState').addEventListener('input', updateCityPreview);
            } else {
                populateCityDropdown();
                document.getElementById('locationModal').style.display = 'flex';
            }
        }
        
        function closeCityModal() {
            document.getElementById('cityModal').style.display = 'none';
        }
        
        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
        }
        
        function closeDeviceModal() {
            document.getElementById('deviceModal').style.display = 'none';
        }
        
        function updateCityPreview() {
            const city = document.getElementById('newCity').value.toUpperCase();
            const state = document.getElementById('newState').value.toUpperCase();
            document.getElementById('cityPreview').textContent = 
                city && state ? `${city}, ${state}` : 'CITY, ST';
        }
        
        function populateCityDropdown() {
            const dropdown = document.getElementById('cityDropdownForLocation');
            const deviceCityDropdown = document.getElementById('deviceCity');
            
            dropdown.innerHTML = '<option value="">Choose a city...</option>';
            deviceCityDropdown.innerHTML = '<option value="">Choose a city...</option>';
            
            const cities = new Set();
            allData.forEach(item => {
                if (item.siteid) cities.add(item.siteid);
            });
            
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                dropdown.appendChild(option.cloneNode(true));
                deviceCityDropdown.appendChild(option);
            });
        }
        
        function updateLocationDropdown() {
            const selectedCity = document.getElementById('deviceCity').value;
            const locationDropdown = document.getElementById('deviceLocation');
            
            locationDropdown.innerHTML = '<option value="">Choose a location...</option>';
            
            // Clear auto-populated fields
            document.getElementById('deviceSiteName').value = '';
            document.getElementById('deviceAddress').value = '';
            document.getElementById('deviceSiteType').value = '';
            
            if (selectedCity) {
                const locations = new Set();
                allData.forEach(item => {
                    if (item.siteid === selectedCity && item.sitename) {
                        locations.add(JSON.stringify({
                            name: item.sitename,
                            address: item.address || '',
                            type: item.sitetype || ''
                        }));
                    }
                });
                
                locations.forEach(locStr => {
                    const loc = JSON.parse(locStr);
                    const option = document.createElement('option');
                    option.value = locStr;
                    option.textContent = loc.name;
                    locationDropdown.appendChild(option);
                });
            }
        }
        
        function updateDeviceFields() {
            const locationValue = document.getElementById('deviceLocation').value;
            
            if (locationValue) {
                const location = JSON.parse(locationValue);
                document.getElementById('deviceSiteName').value = location.name;
                document.getElementById('deviceAddress').value = location.address;
                document.getElementById('deviceSiteType').value = location.type;
            } else {
                document.getElementById('deviceSiteName').value = '';
                document.getElementById('deviceAddress').value = '';
                document.getElementById('deviceSiteType').value = '';
            }
        }
        
        async function createNewCity() {
            const city = document.getElementById('newCity').value.toUpperCase();
            const state = document.getElementById('newState').value.toUpperCase();
            
            if (!city || !state) {
                alert('Please enter both city and state');
                return;
            }
            
            const siteid = `${city}, ${state}`;
            
            try {
                const { error } = await supabaseClient
                    .from('migration_tracker')
                    .insert({ siteid });
                
                if (error) throw error;
                
                closeCityModal();
                loadData();
                
            } catch (error) {
                console.error('Error creating city:', error);
                alert('Failed to create city. Please try again.');
            }
        }
        
        async function createNewLocation() {
            const city = document.getElementById('cityDropdownForLocation').value;
            const locationName = document.getElementById('locationName').value;
            const address = document.getElementById('locationAddress').value;
            const sitetype = document.getElementById('newLocationType').value;
            
            if (!city || !locationName) {
                alert('Please select a city and enter a location name');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('migration_tracker')
                    .insert({
                        siteid: city,
                        sitename: locationName,
                        address: address,
                        sitetype: sitetype
                    });
                
                if (error) throw error;
                
                closeLocationModal();
                loadData();
                
            } catch (error) {
                console.error('Error creating location:', error);
                alert('Failed to create location. Please try again.');
            }
        }
        
        async function createNewDevice() {
            const selectedCity = document.getElementById('deviceCity').value;
            const locationValue = document.getElementById('deviceLocation').value;
            const deviceName = document.getElementById('deviceName').value;
            const deviceType = document.getElementById('deviceType').value;
            
            if (!selectedCity || !locationValue || !deviceName) {
                alert('Please select city, location, and enter device name');
                return;
            }
            
            const location = JSON.parse(locationValue);
            
            try {
                const { error } = await supabaseClient
                    .from('migration_tracker')
                    .insert({
                        siteid: selectedCity,
                        sitename: location.name,
                        address: location.address,
                        sitetype: location.type,
                        devicename: deviceName,
                        devicetype: deviceType,
                        status: 'Active',
                        migrationphase: 'Phase 1',
                        priority: 'Medium'
                    });
                
                if (error) throw error;
                
                closeDeviceModal();
                loadData();
                
            } catch (error) {
                console.error('Error adding device:', error);
                alert('Failed to add device. Please try again.');
            }
        }
        
        function addDevice() {
            populateCityDropdown();
            document.getElementById('deviceModal').style.display = 'flex';
        }
        
        function toggleExportDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
        }
        
        function exportToExcel() {
            const ws_data = [];
            const headers = ['City/State', 'Location', 'Address', 'Site Type', 'Device', 'Device Type', 
                           'Mgmt IP', 'Username', 'Password', 'Status', 'Circuit ID', 'ISP', 
                           'Bandwidth', 'Customers', 'Phase', 'Date', 'Priority', 'Notes'];
            ws_data.push(headers);
            
            allData.forEach(item => {
                if (item.devicename) {
                    ws_data.push([
                        item.siteid || '', item.sitename || '', item.address || '', item.sitetype || '',
                        item.devicename || '', item.devicetype || '', item.managementip || '',
                        item.username || '', item.password || '', item.status || '',
                        item.circuitid || '', item.ispprovider || '', item.bandwidth || '',
                        item.customercount || '', item.migrationphase || '', item.migrationdate || '',
                        item.priority || '', item.notes || ''
                    ]);
                }
            });
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Migration Tracker");
            
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `BeamSpeed_Migration_${today}.xlsx`);
            
            document.getElementById('exportDropdown').classList.remove('show');
        }
        
        function exportToPDF() {
            alert('PDF export will be implemented with jsPDF library');
            document.getElementById('exportDropdown').classList.remove('show');
        }
        
        document.addEventListener('click', () => {
            document.getElementById('exportDropdown')?.classList.remove('show');
        });
        
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html>
